--[[
-- File name: config.lua
-- Author: Fro-Q
-- Created: 2025-11-03 00:41:06
-- Last modified: 2025-11-03 16:42:40
-- ------
-- headup.nvim configuration management
--]]

---@mod headup.config Configuration manager for headup.nvim
--- Parse, validate, and store effective configuration.

---@diagnostic disable: undefined-global
require("headup.types")
local utils = require("headup.utils")

---@type Headup.config
local default_config = {
  enabled = true,
  silent = true,
  time_format = nil,
  max_lines = nil,
  end_pattern = nil,
  exclude_pattern = nil,
  configs = {},
}

-- Default configuration items
local default_config_items = {
  {
    pattern = "*.md",
    match_pattern = "last_modified:%s*(.-)%s*$",
    content = "current_time",
    time_format = "%Y-%m-%d %H:%M:%S",
    max_lines = 20,
    -- Stop at the end of YAML front matter
    end_pattern = "^---%s*$",
  },

}
local Config = {}

---@type Headup.config
Config.config = default_config

--- Parse and validate user configuration
---@param user_config table?
---@return Headup.config
Config.parse = function(user_config)
  -- Parse user configuration
  local parsed_config = {
    enabled = true,
    silent = true,
    time_format = nil,
    max_lines = nil,
    end_pattern = nil,
    exclude_pattern = nil,
    configs = {},
  }

  if user_config then
    -- Extract global settings
    if user_config.enabled ~= nil then
      parsed_config.enabled = user_config.enabled
    end
    if user_config.silent ~= nil then
      parsed_config.silent = user_config.silent
    end

    -- Extract global fallback settings
    if user_config.time_format ~= nil then
      parsed_config.time_format = user_config.time_format
    end
    if user_config.max_lines ~= nil then
      parsed_config.max_lines = user_config.max_lines
    end
    if user_config.end_pattern ~= nil then
      parsed_config.end_pattern = user_config.end_pattern
    end
    if user_config.exclude_pattern ~= nil then
      parsed_config.exclude_pattern = user_config.exclude_pattern
    end

    -- Extract config items (tables with pattern field)
    for _, value in pairs(user_config) do
      if type(value) == "table" and value.pattern then
        table.insert(parsed_config.configs, value)
      end
    end

    -- If no config items found, use default
    if #parsed_config.configs == 0 then
      parsed_config.configs = default_config_items
    end
  else
    -- No user config, use default
    parsed_config.configs = default_config_items
  end

  -- Apply global fallbacks to each item when not provided
  for _, item in ipairs(parsed_config.configs) do
    if item.time_format == nil and parsed_config.time_format ~= nil then
      item.time_format = parsed_config.time_format
    end
    if item.max_lines == nil and parsed_config.max_lines ~= nil then
      item.max_lines = parsed_config.max_lines
    end
    if item.end_pattern == nil and parsed_config.end_pattern ~= nil then
      item.end_pattern = parsed_config.end_pattern
    end
    if item.exclude_pattern == nil and parsed_config.exclude_pattern ~= nil then
      item.exclude_pattern = parsed_config.exclude_pattern
    end
  end

  return parsed_config
end

--- Validate configuration
---@param config Headup.config
---@return boolean success
---@return string? error_message
Config.validate = function(config)
  for i, item_config in ipairs(config.configs) do
    local ok, err = utils.validate_config_item(item_config)
    if not ok then
      return false, "config[" .. i .. "] " .. err
    end
  end
  return true, nil
end

--- Setup configuration
---@param user_config table?
---@return boolean success
Config.setup = function(user_config)
  -- Parse configuration
  local parsed_config = Config.parse(user_config)

  -- Validate configuration
  local success, error_message = Config.validate(parsed_config)
  if not success then
    vim.notify("headup.nvim: " .. error_message, vim.log.levels.ERROR)
    return false
  end

  -- Store validated configuration
  Config.config = parsed_config

  -- Mark that setup has been called
  vim.g.headup_setup_called = true

  return true
end

--- Get current configuration
---@return Headup.config
Config.get = function()
  return Config.config
end

--- Check if plugin is enabled
---@return boolean
Config.is_enabled = function()
  return Config.config.enabled
end

--- Set plugin enabled state
---@param state boolean
Config.set_enabled = function(state)
  Config.config.enabled = not not state
end

--- Check if silent mode is enabled
---@return boolean
Config.is_silent = function()
  return Config.config.silent
end

return Config
